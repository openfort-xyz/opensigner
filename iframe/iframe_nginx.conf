# Extract origin from referrer using regex
map $http_referer $referer_origin {
    "~^(https?://[^/]+)" $1;
    default "";
}

# Determine the request origin (prefer Origin header, fallback to referrer)
map $http_origin $request_origin {
    ""      $referer_origin;
    default $http_origin;
}

# Build Datadog CSP report URL - using server_name as source variable
map $server_name $datadog_csp_url {
    default "https://browser-intake-datadoghq.com/api/v2/logs?dd-api-key=pub5ebcbe7d2df88edc18d7c965b4f26625&dd-evp-origin=content-security-policy&ddsource=csp-report";
}

# Upstream definition
upstream backend {
    server hotstorage:3000 max_fails=3 fail_timeout=30s;
    keepalive 32;
    keepalive_requests 100;
    keepalive_timeout 60s;
}

server {
    listen 5173;
    server_name localhost;

    # Add access log with detailed format
    access_log /var/log/nginx/access.log combined;
    error_log /var/log/nginx/error.log debug;
    
    # Production security headers
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;  # Will be overridden for iframe routes
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()" always;
    add_header Cache-Control "private, no-cache, no-store, max-age=0, must-revalidate" always;
    add_header X-Robots-Tag "noindex, nofollow, noarchive, nosnippet" always;
    
    # Define backend API variable
    set $backend_api "http://hotstorage:3000 http://coldstorage:8080";

    # Generate unique request ID for nonce
    set $request_nonce $request_id;
    
    # Internal auth endpoint for origin validation
    location = /auth-origin {
        internal;
        proxy_pass http://authservice:3000/v1/projects/validate-origin;

        # SSL configuration
        proxy_ssl_verify off;
        
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        # proxy_set_header Authorization "Bearer $api_key";
        proxy_set_header X-Request-Origin $request_origin;
        proxy_set_header X-Original-URI $request_uri;
        proxy_set_header X-Request-ID $request_id;
        proxy_set_header Host api.openfort.io;
        
        # Enhanced timeout settings
        proxy_connect_timeout 5s;
        proxy_read_timeout 5s;
        proxy_send_timeout 5s;
    }

    location ~ ^/(assets|favicon\.ico|vite\.svg|.*\.(js|css|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot))$ {
        root /usr/share/nginx/html;
        
        # Security headers for assets
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "strict-origin" always;
        
        # Allow CORS for assets when embedded
        add_header Access-Control-Allow-Origin "*" always;
        
        include /etc/nginx/mime.types;
        default_type application/octet-stream;
        
        try_files $uri =404;
    }

    
    # Main iframe location with Datadog CSP integration
    location / {
        # set $api_key $1;
        
        # Validate origin against project's allowed origins
        # auth_request /auth-origin;

        error_page 401 403 422 500 502 503 504 = @iframe_auth_error;
        
        # Capture the allowed origins from auth response
        auth_request_set $allowed_origins $upstream_http_x_allowed_origins;
        
        # Apply CSP directly without set variable to avoid timing issues
        # add_header Content-Security-Policy "default-src 'none'; base-uri 'none'; child-src 'none'; object-src 'none'; frame-src 'none'; manifest-src 'self'; font-src 'self'; img-src 'self'; style-src 'self' 'nonce-$request_nonce'; script-src 'self' 'nonce-$request_nonce'; connect-src 'self' $backend_api; frame-ancestors $allowed_origins; report-uri $datadog_csp_url; upgrade-insecure-requests;" always;
        
        # Override X-Frame-Options for iframe context
        add_header X-Frame-Options "ALLOWALL" always;

        sub_filter_once off;
        sub_filter_types text/html;
        sub_filter 'CSP_NONCE_PLACEHOLDER' '$request_nonce';

        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html =404;
        
        # Enhanced MIME type handling
        include /etc/nginx/mime.types;
        default_type application/octet-stream;
        
        # Request tracking
        add_header X-Request-ID $request_id always;
    }
    
    # Nginx status monitoring
    location = /nginx-status {
        stub_status on;
        access_log on;
        allow 127.0.0.1;
        allow 10.0.0.0/8;
        # deny all;
    }
    

    #location / {
    #    return 302 localhost;
    #}
    
    
    # Error pages
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
    
    location = /404.html {
        root /usr/share/nginx/html;
        internal;
    }
    
    location = /50x.html {
        root /usr/share/nginx/html;
        internal;
    }

    location @iframe_auth_error {
        add_header Content-Type "text/html" always;
        add_header X-Frame-Options "ALLOWALL" always;
        return 403 '<html><body></body></html>';
    }
}